import numpy as np

def tansig(x):
    return 2 / (1 + np.exp(-2 * x)) - 1

def mapminmax_apply(x, settings):
    return (x - settings['xoffset'][:, np.newaxis]) * settings['gain'][:, np.newaxis] + settings['ymin']

def mapminmax_reverse(y, settings):
    return (y - settings['ymin']) / settings['gain'] + settings['xoffset']

def ANN_DEL_TowerBase(x1):
    x1 = np.array(x1, dtype=np.float64)
    if x1.ndim == 1:
        x1 = x1.reshape(1, -1)
    if x1.shape[1] != 10:
        raise ValueError("Input must have shape (Q, 10)")

    # Normalize input
    minInputs = np.array([3.36093, 3.43696, 3.36454, 3.41895, 8.07273, 8.23081, 8.67988, 8.44285, -30, 60])
    maxInputs = np.array([14.505, 13.7296, 13.1378, 13.6877, 34.8086, 38.3538, 37.5428, 35.6964, 30, 100])
    x1 = (x1 - minInputs) / (maxInputs - minInputs)
    x1 = x1.T  # (10, Q)

    # Preprocessing settings
    x1_step1 = {
    'xoffset': np.array([0, 0, 0, 0.0062108, 0.00031595, 0, 9.7989e-05, 0, 0, 0]),
    'gain': np.array([2.0001, 2, 2.0025, 2.0125, 2.0006, 2.0768, 2.0627, 2.0816, 2, 2]),
    'ymin': -1
    }

    y1_step1 = {
    'ymin': -1,
    'gain': 2.00004639898127,
    'xoffset': 2.31989524333902e-05
    }

    # Neural net weights (Layer 1 and 2)
    b1 = np.array([
    -0.84162497711391714983,3.2926011373061605525,-3.5555455227097665372,-2.6479150716657304798,0.084908405569389278078,0.88102627456951254636,2.9098095957856964233,-1.5365347904503441345,0.42826877638142596405,3.7171892968014179637,-1.1267062983954521105,-3.1692161198502097896,0.44862185363865647592,0.0059798061670441465809,0.083920952379510360686,0.84092501379816608775,2.1711005707576713775,-4.2343657978014039855,-3.1293738202409504545,0.8873338206250047655,2.2666187777019515259,-0.62458140282536833698,-0.23835990419030628207,0.98971293975353968886,-2.1000912255506865023,-3.5606715080021755782,0.90417012266854923652,3.5767824884756058701,1.5345881333002955316,2.3094900541204097522
    ])

    b2 = -2.3006747078844167476

    IW1_1 = np.array([
    [-0.73314577044910178572,2.8287129130879797856,1.5877100060823403638,-0.41655991975409656369,0.097273890561228509855,0.76547073400483855998,-1.2822206037597951855,-1.3358392133678875791,-0.75065359840991330298,0.64663836274125341408],[1.5248642827357874463,-3.2314794316994297496,1.7278966231683206001,-0.30298572995397865526,0.72700476184016593617,-2.4564350290640657448,1.2808746935876647033,1.0053487209660716406,-0.054567809167083515531,2.7209768015275499486],[0.28835782282312688585,0.25196266795202981736,1.5602359578309927812,-3.0230108648302662644,-0.46104540051838283077,-2.5096224768534929339,1.8853499774504214326,-1.8512802123437130941,-0.0072108241588582930662,-0.23041967859359976933],[-0.77415367781163335614,3.7163062420508929939,-1.7509315664897189269,2.2506471323660499628,1.3290157563979454469,1.668059995930878614,-1.656422715963739023,-1.7085589114292070168,0.17422791589944844337,-3.6101746277618049774],[-1.5303513485698256869,-2.2748699140834407473,-0.91430462986787142121,1.7031083422226245272,-1.0828816400584695412,-0.98542555894232819469,0.1037276115815981975,1.7918445566763228083,-0.53784741045856254704,-0.65362886661162244994],[0.86522561103239303826,-1.8979878431754679813,-2.3638324849762319957,0.25618629740205128842,-0.059741699719734336904,0.10475601801469008878,0.35154240163984706857,1.2612971924108209443,0.6365349018892197952,-0.38892026926383943541],[-0.79717951130863318188,-1.7866528049116900956,2.4630215876678649423,-0.63913856292888571176,-1.3893773844656016614,2.7079192256023270069,-0.29125661831644727995,0.13478783801792221242,-0.44499658388473051218,3.9724902927789829121],[-2.1468840572278589107,0.9352703755387399287,0.10132770290081988263,1.6253429772440892709,-1.5216428365117817822,0.34863189459131382897,0.78567121687563556964,0.45414027770947434925,-1.9967742903415643951,0.0075970659915833233314],[-1.9622237832898525856,-0.5196275506754268747,-0.49067931899208472313,1.2703957847195881392,-1.8868740078256549531,-0.20321123936136653576,0.0068393333651150496968,1.7858073874806812409,0.73084644335656956393,0.25064528334787483654],[-0.16962473066216168793,-0.4820412910738208212,-2.6667827849934657714,0.26643678314280849762,-0.36396044205020244844,0.70354451187386890521,-1.5070895182316543792,0.64104650725093792474,-0.097743213540430612385,0.23728513777661014439],[-2.0410554283327249081,2.2409875745842300354,-3.3692409145696964323,1.7992726503941134375,3.3360986881249572455,-5.2815551713305204373,-1.3296212797003796879,1.2217429384131801573,-0.841507297175366209,0.13936158729076444929],[0.59573552422161712983,1.0939268284690140121,-0.24821226448753863636,0.90249206043346508199,0.048884521935790486991,-1.4927503391566487867,0.58494801191213108282,0.40293803933450045296,0.17579573810353754659,-2.2565382839985974606],[-3.003217538438221812,0.16689719881148923353,-1.2072341549677467754,2.0989368812931874508,-2.68828044483559081,0.089789187146049623256,-0.16780514782287364595,2.2298591801516303157,1.0816517634306781481,0.26847677909972939014],[2.6007224902676857603,-1.5841599436197115747,1.8033171593410857181,2.0662802370864552515,3.2229726791544019981,-2.742900728157287471,-3.2680040921810036281,0.020717209114053735525,-0.28595515157999523703,0.88902634377574718538],[-0.067806483816461329828,-0.57044263506227277372,1.1596014169837842722,0.22113257571278469027,0.025387590261853096307,-0.49286048374576491016,0.54304076803663392514,0.71064831385637960981,-0.10417223206974035588,-0.0025451527067482113478],[1.9733901389574612928,-3.2211131674174855455,1.1553484290512952004,-0.32229981685833380967,0.75261550666368293161,0.45250230577624950268,-1.1797606942277811815,0.49268093789963707252,0.055928184884686579781,-0.6466276570214183339],[2.1847194209233151696,7.4799445854895623143,1.5008151177392070608,-3.3893475854617975962,2.8026167156034351713,2.2073081660885587318,-1.059301959052601827,-3.9302991003224576616,-0.31168274003645601855,1.0023442035188014909],[-1.0012822675596795285,3.7786570396212719736,-1.5391187983334853051,1.5082231272932171695,0.5076885950058169783,2.0380125949109095806,-1.3192904728872731912,-1.4180004251489104483,0.12633077863470865143,-5.0929504755238381719],[-0.18304627197124528903,1.3400325149043699202,-0.89837235922567637569,-0.42078675394242837093,-0.33093212532440458018,-0.7408115596344096998,0.084676027605090173345,-0.98978975904575450251,0.21340927653231867023,-3.1407006287918259879],[2.5193387728473868314,-3.821493486297629083,1.232898839455989437,-0.41211507135204644703,0.93699545365185632484,0.36778373291199067951,-1.2594672431583939787,0.21790666959494661703,0.034140035264000945237,-0.60795236236146654729],[1.3082123553016988815,-3.4381035623023232795,2.7517699733229936676,-0.90629246020718257082,-1.2583091138186555114,-0.20045348812031213437,2.3224016497084756239,2.427759365760023158,-0.48742028493485195506,-0.43576489225969350372],[2.0247588002476799574,-5.7672863071503455146,2.9059326525086923709,-3.0885347866530961092,1.1718578695820622837,-1.1999946584458376364,0.50100566576652905137,-0.015360673044539016607,0.10151112197513319224,0.4356303017492557661],[-0.93393218008519962581,0.64171898024523155168,1.023475356251981605,0.76994444322229005362,0.0017456347202525939258,-0.68139090263893797861,0.61126408278564436927,0.81643466536731568173,0.014151016775331910422,-0.086222718181227217538],[1.8183996949330099024,-1.7967012399631754338,-2.7511476216865724531,-0.51109837604499930297,0.79887842815691212373,0.27193910857010389348,-0.1902934397636798225,0.82527332004905529228,0.65955179319892687229,-0.16076368288437462017],[-1.2246223321522089478,-0.69509471386913646018,-0.42086785651448577195,-0.49097759089980991254,-0.4865173574821159419,0.28812302580508780681,-0.045462622534334709568,0.093102031617319419565,0.19333531890690489052,0.012094259414969908695],[-0.54101497318564562011,1.2388363152547523516,-0.30955098884267412407,-1.392671060071018152,-0.41859130758748908097,-1.317798628211867662,0.78919075197092092289,-2.0879724454419670288,0.097897549005229261843,-0.14961949963903720118],[1.4177445562189072703,-0.82515637413414044676,0.88588242220425783557,-0.34037545844659078398,0.31647122672771083041,-0.23094740010168765543,0.22799798175246874243,0.095345910302176886675,-0.97966442188203683994,-0.0092327981091944264641],[-2.2112173391171525694,-1.8611402239423604499,-2.3948251375710736255,2.1189191474442701235,-2.4741654686139198382,0.88603393775006400457,4.1079702530789621306,-2.9367523072645185245,1.1592749369028840789,1.3701901834073804132],[0.93143002684612163922,-0.14344885948265617692,1.1995637416196398561,0.28328117071913810898,0.45140818370239166324,-0.75852423832135040804,0.38185990585530588115,0.54079499622638393941,0.044295733610979950989,-0.037952765478541115873],[0.19243565191640349399,-1.4366255458599905825,1.1866271182270113904,-0.48875760449992750045,-0.70944926486675308208,0.36540425943677817822,0.84621843351843117897,2.0413312531345848555,-0.18591285470335938701,-0.56987556083528989603]
    ])

    LW2_1 = np.array([
    -1.5215356135284230366,-1.6873883124842390391,2.0336088364213265045,2.6545247035270689295,0.67160716513933493843,-3.1828666758077464038,-0.35635939569553681805,-0.33893787265169356138,-3.0241455728900232813,1.62923025968103663,0.14749904795098447985,1.3144064013359400001,1.9046511649408164324,0.13075523505242278577,4.3909186600635399245,1.9474791474145720649,0.34986448736695469064,-3.9349793399422487994,-0.64947227496624837517,-1.9724256225350846883,0.61284660942039126397,-0.66138775495356272316,-2.6816093520633064173,1.6214899539771308046,-3.7559955941453302408,-3.9550864584222495957,-1.4666535406999394731,0.10995980227284518627,-3.4955477027595240891,-1.0646902469579164752
    ])

    # Forward pass
    Q = x1.shape[1]
    xp1 = mapminmax_apply(x1, x1_step1)
    a1 = tansig(np.outer(b1, np.ones(Q)) + IW1_1 @ xp1)
    a2 = tansig(b2 + LW2_1 @ a1)
    y1 = mapminmax_reverse(a2, y1_step1)

    # Denormalize output
    minOutput = 2180.7944
    maxOutput = 26125.8109
    y1 = y1.T * (maxOutput - minOutput) + minOutput

    return y1